'use strict';

/**
 * Module dependencies.
 */
var _ = require('lodash'),
	errorHandler = require('../errors.server.controller'),
	mongoose = require('mongoose'),
	passport = require('passport'),
	User = mongoose.model('User'),
	Config = mongoose.model('Config'),
	Order = mongoose.model('Order'),
    formidable = require('formidable'),
    fs = require('fs'),
	path = require('path'),
	configs = require('../../../config/config'),
	nodemailer = require('nodemailer'),
	jsreport = require('jsreport');
	
	

	
exports.generateReportUser = function(req, res){
	User.findOne({username: req.body.username}, function(err, user){
		if(err || user === null) return res.status(400).send({message: 'Could not generate report!'});
		Order.find({username: req.body.username, created: {$gt: req.body.start, $lt: req.body.end}}, function(err, orders){
			if(err) return res.status(400).send({message: 'Could not generate report!'});
			
			//Read the sample html file for pdf format
			var sample = fs.readFileSync(path.resolve(__dirname, '../../reportTemplates/finance-user.html'), 'utf8');
			//Render PDF with the given details
			console.log('rendering');
			var today = new Date();//.getDate();
			
			var total = 0; 
			for(var j = 0; j < orders.length; j++)
				{total += orders[j].price * orders[j].quantity;}
									
			
			jsreport.render({
				template:{ content: sample,
					helpers: 'function mult(a,b){ return a*b; }',//'function total(order){return 10;}'],
					engine: 'handlebars'},
				data: {
					title: 'Spending History for user ' + user.displayName,
					description: 'Generated by finance',
					footer: 'Resolve Cafeteria Management System',
					date: today.getDate() + '-' + (today.getMonth()+1)+ '-' + today.getFullYear(),
					to: { name: user.displayName, mail: user.email},
					start: req.body.start,
					end: req.body.end,
					items: orders,
					total: total
				}
			}).then(function(out) {
				//if(err) return res.status(400).send({message: 'Could not render report!'})
				console.log('in render function');
				out.stream.pipe(res);
			});
		});
	});
	
};

exports.generateReportAll = function(req, res){
	/*User.find({}, function(err, users){
		if(err) return res.status(400);
		var result = [], resultCount = 0;*/
		Order.aggregate([{ $group: {_id: '$username', total: {$sum: {$multiply: ['$price', '$quantity']}}}}
		], function(err, docs){
			
			//Read the sample html file for pdf format
			var sample = fs.readFileSync(path.resolve(__dirname, '../../reportTemplates/finance-all.html'), 'utf8');
			
			var total = 0;
			for(var i = 0; i < docs.length; i++){
				total += docs[i].total;
			}
			var today = new Date();
			
			jsreport.render({
				template:{ content: sample,
					engine: 'handlebars'},
				data: {
					title: 'Report of User spending',
					description: 'Generated by Finance',
					footer: 'Resolve Cafeteria Management System',
					date: today.getDate() + '-' + (today.getMonth()+1)+ '-' + today.getFullYear(),
					start: req.body.start,
					end: req.body.end,
					items: docs,
					tot: total
				}
			}).then(function(out) {
				//if(err) return res.status(400).send({message: 'Could not render report!'})
				console.log('in render function');
				out.stream.pipe(res);
			});
		});
	/*});*/
};